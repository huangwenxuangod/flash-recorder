name: Release Windows

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (e.g. v0.1.0)"
        required: true
        type: string
      name:
        description: "Release title (defaults to tag)"
        required: false
        type: string
      prerelease:
        description: "Mark as prerelease"
        required: false
        type: boolean

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: "pnpm"

      - name: Enable Corepack
        run: corepack enable

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Prepare ffmpeg for bundling
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force "src-tauri/ffmpeg" | Out-Null
          $zipUrl = "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip"
          Invoke-WebRequest -Uri $zipUrl -OutFile "ffmpeg.zip"
          Expand-Archive -Path "ffmpeg.zip" -DestinationPath "ffmpeg_zip" -Force
          $ff = Get-ChildItem -Path "ffmpeg_zip" -Recurse -Filter "ffmpeg.exe" | Select-Object -First 1
          Copy-Item $ff.FullName "src-tauri/ffmpeg/ffmpeg.exe" -Force

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Tauri (Windows)
        run: pnpm run tauri build

      - name: Set release metadata
        if: ${{ startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch' }}
        shell: pwsh
        run: |
          if ("${{ github.event_name }}" -eq "workflow_dispatch") {
            $tag = "${{ inputs.tag }}"
            $name = "${{ inputs.name }}"
            if ([string]::IsNullOrWhiteSpace($name)) { $name = $tag }
          } else {
            $tag = "${{ github.ref_name }}"
            $name = $tag
          }
          Add-Content -Path $env:GITHUB_ENV -Value "RELEASE_TAG=$tag"
          Add-Content -Path $env:GITHUB_ENV -Value "RELEASE_NAME=$name"

      - name: Generate checksums
        shell: pwsh
        run: |
          $bundle = "src-tauri/target/release/bundle"
          Get-ChildItem "$bundle/msi/*.msi","$bundle/nsis/*.exe" -ErrorAction SilentlyContinue | ForEach-Object {
            $hash = Get-FileHash $_.FullName -Algorithm SHA256
            $hashLine = "$($hash.Hash)  $($_.Name)"
            $outFile = "$($_.FullName).sha256"
            $hashLine | Out-File -FilePath $outFile -Encoding ascii
          }

      - name: Upload Release Assets
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: ${{ env.RELEASE_NAME }}
          prerelease: ${{ inputs.prerelease }}
          generate_release_notes: true
          files: |
            src-tauri/target/release/bundle/msi/*.msi
            src-tauri/target/release/bundle/msi/*.sha256
            src-tauri/target/release/bundle/nsis/*.exe
            src-tauri/target/release/bundle/nsis/*.sha256
